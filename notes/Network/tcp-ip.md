# TCP/IP

不同国家的人使用不同的语言交流，可以认为是一种协议，只不过我们称之为语言。因为协议的存在，计算机之间才能正确通信。

很多常见的应用层协议是以 TCP 为基础的，比如“HTTP、FTP、SMTP、POP、IMAP”等。这些协议需要依靠 TCP 协议来传输数据。TCP 也被称为“面向连接”的传输层协议。

## 五层模型

互联网的实现，分成好几层。每一层都有自己的功能，就像建筑物一样，每一层都靠下一层支持。

用户接触到的，只是最上面的一层，根本没有感觉到下面的层。要理解互联网，必须从最下层开始，自下而上理解每一层的功能。

![](http://image.beekka.com/blog/201205/bg2012052902.png)

上图中: 越下面的层，越靠近硬件；越上面的层，越靠近用户。

每一层都是为了完成一种功能。为了实现这些功能，就需要大家都遵守共同的规则。

大家都遵守的规则，就叫做"协议"（protocol）。

互联网的每一层，都定义了很多协议。这些协议的总称，就叫做"互联网协议"（Internet Protocol Suite）。

## 实体层

电脑要组网，第一件事要先把电脑连起来，可以用光缆、电缆、双绞线、无线电波等方式。
这就叫做"实体层"，它就是把电脑连接起来的物理手段。它主要规定了网络的一些电气特性，作用是负责传送0和1的电信号。

## 链接层

链接层的功能，是确定实体层传输过来的0和1的分组方式，这种分组方式就是一种协议。

### 以太网协议

协议规定，一组电信号构成一个数据包，叫做"帧"（Frame）。每一帧分成两个部分：标头（Head）和数据（Data）。

![Ethernet protocol](http://image.beekka.com/blog/201205/bg2012052904.png)

"Head"包含数据包的一些说明项，比如发送者、接受者、数据类型等等，"Head"的长度，固定为18字节。

"Data"则是数据包的具体内容。"Data"的长度，最短为46字节，最长为1500字节。

整个"帧"最短为64字节，最长为1518字节。如果数据很长，就必须分割成多个帧进行发送。

### MAC地址

规定所有连入网络的所有设备，都必须具有"网卡"接口，数据必须是通过网卡交换的。网卡的地址就是**MAC地址**。

每块网卡出厂的时候，都有一个全世界独一无二的MAC地址，长度是48个二进制位，通常用12个十六进制数表示。

前6个十六进制数是厂商编号，后6个是该厂商的网卡流水号。

### 广播

以太网数据包必须知道接收方的MAC地址，而网卡通过ARP协议知道另一块网卡的MAC地址。

知道地址后向本网络内所有计算机发送，让每台计算机自己判断，是否为接收方，通过这样把数据包准确送到接收方。

![broadcasting](http://image.beekka.com/blog/201205/bg2012052907.png)

网络内计算机都会读取这个包的"标头"，找到接收方的MAC地址，然后与自身的MAC地址相比较，如果两者相同，就接受这个包，做进一步处理，否则就丢弃这个包。
这种发送方式就叫做**"广播"（broadcasting）**。

## 网络层

互联网是无数子网络共同组成的一个巨型网络。

以太网采用广播方式发送数据包，所有成员人手一"包"，不仅效率低，而且局限在发送者所在的子网络。也就是说，如果两台计算机不在同一个子网络，广播是传不过去的。

![internet](http://image.beekka.com/blog/201205/bg2012052914.png)

因为MAC地址不能区分子网络，这就导致了"网络层"的诞生。它的作用是引进一套新的地址，使得我们能够区分不同的计算机是否属于同一个子网络。这套地址就叫做**"网络地址"**，简称**"网址"**。

每台计算机有了两种地址，一种是**MAC地址**，另一种是**网络地址**。两种地址之间没有任何联系，MAC地址是绑定在网卡上的，网络地址则是管理员分配的，它们只是随机组合在一起。

所以网络寻址先处理网络地址，然后再处理MAC地址。先确定计算机所在的子网络，再将数据包送到子网络中的目标网卡上。

### IP协议

规定网络地址的协议，叫做IP协议。它所定义的地址，就被称为IP地址。

IP协议的作用主要有两个，一个是为每一台计算机分配IP地址，另一个是确定哪些地址在同一个子网络。

目前，广泛采用的是IP协议第四版，简称IPv4。这个版本规定，网络地址由32个二进制位组成。我们用分成四段的十进制数表示IP地址，从0.0.0.0一直到255.255.255.255。

![IPv4](http://image.beekka.com/blog/201205/bg2012052908.png)

互联网上的每一台计算机，都会分配到一个IP地址。这个地址分成两个部分，前一部分代表网络，后一部分代表主机。处于同一个子网络的电脑，它们IP地址的网络部分是相同的.

IP地址的网络位需要**"子网掩码"（subnet mask）**来确定，所谓**"子网掩码"**，就是表示子网络特征的一个参数。
它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。

### IP数据包

根据IP协议发送的数据，就叫做IP数据包。它也分为"Head"和"Data"两个部分。

"Head"部分主要包括版本、长度、IP地址等信息

"Data"部分则是IP数据包的具体内容。它放进以太网数据包后，以太网数据包就变成了下面这样。

![](http://image.beekka.com/blog/201205/bg2012052910.png)

IP数据包的"标头"部分的长度为20到60字节，整个数据包的总长度最大为65,535字节。

### ARP协议

## 传输层

使用"端口"（port）区分计算机上不同程序的数据包，它其实是每一个使用网卡的程序的编号。每个数据包都发到主机的特定端口，所以不同的程序就能取到自己所需要的数据。

"端口"是0到65535之间的一个整数，正好16个二进制位。0到1023的端口被系统占用，应用程序只能在大于1023的端口随机选择，与服务器的相应端口联系。

"传输层"的功能，就是建立"端口到端口"的通信。相比之下，"网络层"的功能是建立"主机到主机"的通信。
只要确定主机和端口，我们就能实现程序之间的交流。Unix系统就把主机+端口，叫做"套接字"（socket）。

### UDP

在数据包中加入端口信息，和加入MAC地址和IP相同，需要协议支持。

UDP协议格式，几乎就是在数据前面加上端口号，数据包包含"Head"和"Data"

"Head"部分主要定义了发出端口和接收端口，一共只有8个字节

"Data"部分就是具体的内容。

把整个UDP数据包放入IP数据包的"数据"部分，IP数据包又是放在以太网数据包之中的

![以太网数据包](http://image.beekka.com/blog/201205/bg2012052912.png)

UDP的缺点是可靠性较差，一旦数据包发出，无法知道对方是否收到。

### TCP

近似有确认机制的UDP协议，每发出一个数据包都要求确认。如果有一个数据包遗失，就收不到确认，发出方就知道有必要重发这个数据包了。

TCP提高的网络可靠性，但是过程复杂、实现困难、消耗较多的资源。

## 应用层

程序收到"传输层"的数据，再通过数据格式对数据进行解读。**"应用层"的作用，就是规定应用程序的数据格式。**

比如Email程序需要有协议规定电子邮件的数据格式，才能将数据包解读。

![完全数据包](http://image.beekka.com/blog/201205/bg2012052913.png)